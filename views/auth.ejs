<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆæƒ - Copilot OpenAI Proxy</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-2xl">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-900 mb-2">ğŸ” GitHub æˆæƒ</h1>
      <p class="text-gray-600">æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤å®Œæˆæˆæƒ</p>
    </div>

    <!-- Authorization Steps -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <!-- Step 1: Copy Code -->
      <div class="mb-8">
        <div class="flex items-center mb-4">
          <div class="flex-shrink-0 w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold">
            1
          </div>
          <h3 class="ml-3 text-xl font-semibold">å¤åˆ¶éªŒè¯ç </h3>
        </div>
        
        <div class="ml-13 bg-gray-50 p-4 rounded-lg border-2 border-gray-200">
          <p class="text-sm text-gray-600 mb-2">éªŒè¯ç ï¼š</p>
          <div class="flex items-center gap-3">
            <code id="userCode" class="text-3xl font-mono font-bold text-blue-600 tracking-wider">
              <%= deviceCode.user_code %>
            </code>
            <button onclick="copyCode()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
              å¤åˆ¶
            </button>
          </div>
        </div>
      </div>

      <!-- Step 2: Visit GitHub -->
      <div class="mb-8">
        <div class="flex items-center mb-4">
          <div class="flex-shrink-0 w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold">
            2
          </div>
          <h3 class="ml-3 text-xl font-semibold">è®¿é—® GitHub æˆæƒé¡µé¢</h3>
        </div>
        
        <div class="ml-13">
          <a href="<%= deviceCode.verification_uri %>" target="_blank" 
             class="inline-block bg-gray-900 hover:bg-gray-800 text-white px-6 py-3 rounded-lg font-medium transition">
            ğŸ”— æ‰“å¼€ GitHub æˆæƒé¡µé¢
          </a>
          <p class="text-sm text-gray-500 mt-2">
            æˆ–è®¿é—®: <code class="bg-gray-100 px-2 py-1 rounded"><%= deviceCode.verification_uri %></code>
          </p>
        </div>
      </div>

      <!-- Step 3: Authorize -->
      <div class="mb-8">
        <div class="flex items-center mb-4">
          <div class="flex-shrink-0 w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold">
            3
          </div>
          <h3 class="ml-3 text-xl font-semibold">è¾“å…¥éªŒè¯ç å¹¶æˆæƒ</h3>
        </div>
        
        <div class="ml-13">
          <p class="text-gray-600">åœ¨ GitHub é¡µé¢ä¸­ç²˜è´´éªŒè¯ç å¹¶å®Œæˆæˆæƒ</p>
        </div>
      </div>

      <!-- Status -->
      <div class="border-t pt-6">
        <div id="status" class="text-center">
          <div class="inline-flex items-center text-blue-600">
            <svg class="animate-spin h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-lg font-medium">ç­‰å¾…æˆæƒä¸­...</span>
          </div>
          <p class="text-sm text-gray-500 mt-2" id="countdown"></p>
        </div>
      </div>
    </div>

    <!-- Back Button -->
    <div class="text-center mt-6">
      <a href="/" class="text-blue-500 hover:text-blue-600 hover:underline">
        â† è¿”å›é¦–é¡µ
      </a>
    </div>
  </div>

  <script>
    const deviceCode = '<%= deviceCode.device_code %>'
    let pollCount = 0
    const maxPolls = 120 // 10 minutes

    function copyCode() {
      const code = document.getElementById('userCode').textContent.trim()
      navigator.clipboard.writeText(code).then(() => {
        alert('éªŒè¯ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼')
      }).catch(err => {
        console.error('Failed to copy:', err)
      })
    }

    async function pollAuth() {
      if (pollCount >= maxPolls) {
        document.getElementById('status').innerHTML = `
          <div class="text-red-600">
            <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="text-lg font-medium">æˆæƒè¶…æ—¶</p>
            <a href="/auth" class="text-blue-500 hover:underline mt-2 inline-block">é‡æ–°å¼€å§‹</a>
          </div>
        `
        return
      }

      pollCount++
      const remaining = maxPolls - pollCount
      document.getElementById('countdown').textContent = 
        `å‰©ä½™æ—¶é—´: ${Math.floor(remaining * 5 / 60)} åˆ†é’Ÿ (${pollCount}/${maxPolls})`

      try {
        const response = await fetch('/api/poll-auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ device_code: deviceCode })
        })

        const data = await response.json()

        if (data.success && data.authorized) {
          // Success!
          document.getElementById('status').innerHTML = `
            <div class="text-green-600">
              <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <p class="text-lg font-medium">æˆæƒæˆåŠŸï¼</p>
              <p class="text-sm mt-2">æ­£åœ¨è·³è½¬...</p>
            </div>
          `
          setTimeout(() => {
            window.location.href = '/success'
          }, 1500)
        } else if (data.pending) {
          // Still waiting
          setTimeout(pollAuth, 5000) // Poll every 5 seconds
        } else {
          // Error
          document.getElementById('status').innerHTML = `
            <div class="text-red-600">
              <p class="text-lg font-medium">æˆæƒå¤±è´¥</p>
              <p class="text-sm mt-2">${data.error || 'æœªçŸ¥é”™è¯¯'}</p>
              <a href="/auth" class="text-blue-500 hover:underline mt-2 inline-block">é‡æ–°å¼€å§‹</a>
            </div>
          `
        }
      } catch (error) {
        console.error('Poll error:', error)
        setTimeout(pollAuth, 5000)
      }
    }

    // Start polling
    setTimeout(pollAuth, 5000)
  </script>
</body>
</html>
